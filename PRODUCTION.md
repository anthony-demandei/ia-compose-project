# IA Compose API - Production Deployment Guide

## ğŸš€ Overview

This guide provides comprehensive instructions for deploying the IA Compose API to production using Coolify on a VPS.

**Production URL:** https://compose.demandei.com.br  
**Technology Stack:** FastAPI + Redis + Docker + Coolify  
**AI Provider:** Google Gemini (1.5 Pro with fallback chain)

## ğŸ“‹ Prerequisites

Before deploying, ensure you have:

1. **VPS with Coolify installed**
   - Minimum 2 CPU cores
   - 4GB RAM
   - 20GB SSD storage
   - Ubuntu 22.04 LTS recommended

2. **Domain configured**
   - Domain: compose.demandei.com.br
   - DNS A record pointing to VPS IP
   - SSL certificate (auto-generated by Coolify/Caddy)

3. **API Keys**
   - Demandei API Key (production)
   - Google Gemini API Key
   - Redis password (optional but recommended)

## ğŸ”§ Configuration Steps

### 1. Environment Setup

Copy and configure the production environment file:

```bash
cp .env.example .env.production
```

Edit `.env.production` with your production values:

```env
ENVIRONMENT=production
DEBUG=false
DEMANDEI_API_KEY=your_production_api_key_here
GEMINI_API_KEY=your_gemini_api_key_here
REDIS_PASSWORD=your_redis_password_here
```

### 2. Coolify Setup

#### Option A: Using Coolify UI

1. **Create New Application**
   - Type: Docker Compose
   - Name: ia-compose-api
   - Domain: compose.demandei.com.br

2. **Configure Build**
   - Source: Git repository or direct upload
   - Dockerfile: `Dockerfile`
   - Docker Compose: `docker-compose.production.yml`

3. **Set Environment Variables**
   ```
   DEMANDEI_API_KEY=<secret>
   GEMINI_API_KEY=<secret>
   REDIS_PASSWORD=<secret>
   ```

4. **Configure Resources**
   - CPU: 2 cores
   - Memory: 2GB
   - Storage: 10GB

#### Option B: Using Coolify CLI

```bash
# Deploy using coolify.yml
coolify deploy --config coolify.yml
```

### 3. Manual Deployment

If deploying manually without Coolify UI:

```bash
# 1. Clone repository on VPS
git clone https://github.com/demandei/ia-compose-api.git
cd ia-compose-api

# 2. Create production environment
cp .env.example .env.production
nano .env.production  # Edit with production values

# 3. Run deployment script
chmod +x deploy.sh
./deploy.sh

# Or manually with docker-compose
docker-compose -f docker-compose.production.yml up -d
```

## ğŸ—ï¸ Architecture

### Production Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Coolify/Caddy               â”‚
â”‚     (SSL Termination & Proxy)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      IA Compose API (Port 8001)     â”‚
â”‚         FastAPI Application         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Redis Cache (Port 6379)        â”‚
â”‚    Session & Document Caching       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Volume Structure

```
/app/
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ documents/    # Generated documents
â”‚   â”œâ”€â”€ sessions/     # Session data
â”‚   â””â”€â”€ uploads/      # Uploaded files
â”œâ”€â”€ logs/            # Application logs
â””â”€â”€ certs/           # SSL certificates (if needed)
```

## ğŸ” Security Configuration

### 1. API Authentication

All endpoints require Bearer token authentication:

```http
Authorization: Bearer your_demandei_api_key
```

### 2. CORS Configuration

Production CORS settings allow:
- `https://*.demandei.com.br`
- `https://demandei.com.br`
- `https://compose.demandei.com.br`

### 3. Rate Limiting (when enabled)

Default limits:
- 100 requests per minute
- 1000 requests per hour
- 10000 requests per day

### 4. Security Headers

Automatically configured:
- HSTS (Strict-Transport-Security)
- Content-Security-Policy
- X-Content-Type-Options
- X-Frame-Options

## ğŸ“Š Monitoring

### Health Checks

- **Main Health:** https://compose.demandei.com.br/health
- **API Docs:** https://compose.demandei.com.br/docs
- **Metrics:** https://compose.demandei.com.br/metrics (if enabled)

### Log Monitoring

```bash
# View API logs
docker logs ia-compose-api -f

# View Redis logs
docker logs ia-compose-redis -f

# Check log files
tail -f logs/app.log
```

### Performance Monitoring

```bash
# Check resource usage
docker stats ia-compose-api ia-compose-redis

# Check Redis cache status
docker exec ia-compose-redis redis-cli INFO stats
```

## ğŸ”„ Deployment Workflow

### Initial Deployment

1. **Prepare VPS**
   ```bash
   # Update system
   sudo apt update && sudo apt upgrade -y
   
   # Install Docker (if not via Coolify)
   curl -fsSL https://get.docker.com | sh
   ```

2. **Deploy Application**
   ```bash
   # Using deployment script
   ./deploy.sh
   
   # Or step by step
   ./deploy.sh prepare  # Prepare volumes
   ./deploy.sh build    # Build image
   ./deploy.sh deploy   # Deploy services
   ./deploy.sh health   # Check health
   ```

### Update Deployment

```bash
# 1. Pull latest changes
git pull origin main

# 2. Rebuild and deploy
docker-compose -f docker-compose.production.yml build
docker-compose -f docker-compose.production.yml up -d

# 3. Verify deployment
curl https://compose.demandei.com.br/health
```

### Rollback

```bash
# Stop current deployment
docker-compose -f docker-compose.production.yml down

# Checkout previous version
git checkout <previous-commit>

# Redeploy
docker-compose -f docker-compose.production.yml up -d
```

## ğŸ› ï¸ Maintenance

### Backup

```bash
# Backup storage and logs
tar -czf backup-$(date +%Y%m%d).tar.gz storage/ logs/

# Backup Redis data
docker exec ia-compose-redis redis-cli BGSAVE
```

### Restore

```bash
# Restore from backup
tar -xzf backup-20240101.tar.gz

# Restart services
docker-compose -f docker-compose.production.yml restart
```

### Clear Cache

```bash
# Clear Redis cache
docker exec ia-compose-redis redis-cli FLUSHALL

# Clear local storage (careful!)
rm -rf storage/sessions/*
rm -rf storage/documents/*
```

## ğŸš¨ Troubleshooting

### Common Issues

1. **Service won't start**
   ```bash
   # Check logs
   docker-compose -f docker-compose.production.yml logs
   
   # Check environment
   docker-compose -f docker-compose.production.yml config
   ```

2. **Redis connection failed**
   ```bash
   # Check Redis status
   docker exec ia-compose-redis redis-cli ping
   
   # Check network
   docker network ls
   docker network inspect ia-compose-network
   ```

3. **API returns 401**
   - Verify DEMANDEI_API_KEY is set correctly
   - Check Bearer token in requests
   - Verify environment variables are loaded

4. **CORS errors**
   - Verify domain in CORS settings
   - Check SSL certificate is valid
   - Ensure HTTPS is being used

### Debug Mode

For troubleshooting, temporarily enable debug mode:

```bash
# Edit .env.production
DEBUG=true
LOG_LEVEL=DEBUG

# Restart services
docker-compose -f docker-compose.production.yml restart
```

**Remember to disable debug mode after troubleshooting!**

## ğŸ“ Environment Variables Reference

### Required

| Variable | Description | Example |
|----------|-------------|---------|
| `DEMANDEI_API_KEY` | API key for authentication | `prod_key_xxxxx` |
| `GEMINI_API_KEY` | Google Gemini API key | `AIzaSyXXXXX` |

### Optional but Recommended

| Variable | Description | Default |
|----------|-------------|---------|
| `REDIS_PASSWORD` | Redis authentication | (empty) |
| `LOG_LEVEL` | Logging verbosity | `WARNING` |
| `RATE_LIMIT_ENABLED` | Enable rate limiting | `true` |
| `CORS_ORIGINS` | Allowed CORS origins | `["https://*.demandei.com.br"]` |

## ğŸ¤ Support

For deployment assistance or issues:

1. **Check Documentation**
   - This guide
   - [Coolify Docs](https://coolify.io/docs)
   - [FastAPI Docs](https://fastapi.tiangolo.com)

2. **Contact Support**
   - Email: support@demandei.com.br
   - Slack: #ia-compose-api channel

3. **Report Issues**
   - GitHub Issues: https://github.com/demandei/ia-compose-api/issues

## âœ… Post-Deployment Checklist

- [ ] Environment variables configured
- [ ] SSL certificate active
- [ ] Health check passing
- [ ] API documentation accessible
- [ ] Redis cache working
- [ ] Logs being generated
- [ ] Backup schedule configured
- [ ] Monitoring alerts set up
- [ ] Rate limiting tested
- [ ] CORS working correctly
- [ ] Performance benchmarked
- [ ] Security scan completed

## ğŸ”„ CI/CD Integration (Optional)

### GitHub Actions

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to Coolify
        run: |
          curl -X POST ${{ secrets.COOLIFY_WEBHOOK_URL }}
```

### GitLab CI

```yaml
# .gitlab-ci.yml
deploy:
  stage: deploy
  script:
    - curl -X POST $COOLIFY_WEBHOOK_URL
  only:
    - main
```

---

**Last Updated:** November 2024  
**Version:** 3.2.0  
**Maintained by:** Demandei DevOps Team